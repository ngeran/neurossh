import os, yaml, uuid
from textual.app import App, ComposeResult
from textual.widgets import Header, Footer, Tree, Tabs, Tab, ContentSwitcher, Button, Static, Input, Select
from textual.containers import Horizontal, Vertical
from textual.screen import ModalScreen
from textual import on

from models import SessionConfig, LOCAL_VAULT, get_all_profiles
from terminal import CyberTerminal

class SessionModal(ModalScreen):
    def __init__(self, config=None, folders=None):
        super().__init__()
        self.config = config
        self.folder_options = [("New Folder...", "NEW")] + [(f, f) for f in (folders or []) if f != "Root"]

    def compose(self) -> ComposeResult:
        profiles = get_all_profiles()
        is_edit = self.config is not None
        initial_p = self.config.profile if is_edit else (profiles[0][1] if profiles else Select.BLANK)

        with Vertical(id="modal-dialog"):
            yield Static("NEURAL LINK CONFIG", id="modal-title")
            yield Static("Name", classes="field-label")
            yield Input(value=self.config.name if is_edit else "", id="name")
            yield Static("Host", classes="field-label")
            yield Input(value=self.config.host if is_edit else "", id="host")
            yield Static("Folder", classes="field-label")
            yield Select(self.folder_options, id="folder_select", value=self.config.folder if is_edit else "Root")
            yield Input(placeholder="Enter Folder...", id="new_folder_input", value=self.config.folder if is_edit else "Root")
            yield Static("Profile", classes="field-label")
            yield Select(profiles, id="profile", value=initial_p, allow_blank=True)
            with Horizontal(classes="button-row"):
                yield Button("SAVE", id="save", classes="btn-neuro-confirm")
                yield Button("ABORT", id="cancel", classes="btn-neuro-cancel")

    def on_mount(self):
        if self.query_one("#folder_select").value != "NEW":
            self.query_one("#new_folder_input").display = False

    @on(Select.Changed, "#folder_select")
    def toggle_input(self, event):
        self.query_one("#new_folder_input").display = (event.value == "NEW")

    def on_button_pressed(self, event: Button.Pressed):
        if event.button.id == "save":
            folder = self.query_one("#new_folder_input").value if self.query_one("#folder_select").value == "NEW" else self.query_one("#folder_select").value
            self.dismiss({
                "id": self.config.id if self.config else str(uuid.uuid4())[:8],
                "name": self.query_one("#name").value,
                "host": self.query_one("#host").value,
                "folder": folder or "Root",
                "profile": self.query_one("#profile").value if self.query_one("#profile").value != Select.BLANK else "DEV"
            })
        else: self.dismiss(None)

class NeuroSSH(App):
    TITLE = "N Îž U R O _ S S H // PULSAR"
    CSS_PATH = "neuro.tcss"
    BINDINGS = [
        ("ctrl+n", "new_session", "New"), ("ctrl+h", "focus_sidebar", "Sidebar"), 
        ("ctrl+l", "focus_terminal", "Terminal"), ("e", "edit_node", "Edit"), 
        ("d", "delete_node", "Delete"), ("q", "quit", "Quit")
    ]

    def compose(self) -> ComposeResult:
        yield Header()
        with Horizontal():
            with Vertical(id="sidebar"):
                yield Static("NEURAL ARCHIVE", id="sidebar-title")
                yield Tree("DEVICES", id="session-tree")
            with Vertical(id="main-area"):
                yield Tabs(id="session-tabs")
                with ContentSwitcher(initial="splash", id="view-stack"):
                    yield Static(">> SYSTEM IDLE.", id="splash")
        yield Footer()

    def on_mount(self):
        self.load_sessions()
        self.query_one("#session-tree").focus()

    def load_sessions(self):
        tree = self.query_one("#session-tree")
        tree.clear()
        tree.root.expand()
        if os.path.exists(LOCAL_VAULT):
            with open(LOCAL_VAULT, "r") as f:
                data = yaml.safe_load(f) or []
                for s in data:
                    conf = SessionConfig(**s)
                    folder_name = conf.folder or "Root"
                    folder = next((n for n in tree.root.children if str(n.label) == folder_name), None) or tree.root.add(folder_name, expand=True)
                    folder.add_leaf(conf.name or conf.host, data=conf)

    @on(Tree.NodeSelected)
    def handle_selection(self, event):
        if event.node.data:
            tabs, stack = self.query_one("#session-tabs"), self.query_one("#view-stack")
            tid = f"id_{event.node.data.id}"
            
            if tid not in [t.id for t in tabs.query("Tab")]:
                tabs.add_tab(Tab(str(event.node.data.name or event.node.data.host), id=tid))
                # NO WRAPPER - Direct terminal mount
                stack.mount(CyberTerminal(event.node.data, id=tid))
                
            tabs.active, stack.current = tid, tid
            self.query_one(f"#{tid}").focus()

    def action_new_session(self):
        f = [str(n.label) for n in self.query_one("#session-tree").root.children]
        self.push_screen(SessionModal(folders=f), self.save_cb)

    def action_edit_node(self):
        node = self.query_one("#session-tree").cursor_node
        if node and node.data:
            f = [str(n.label) for n in self.query_one("#session-tree").root.children]
            self.push_screen(SessionModal(config=node.data, folders=f), self.save_cb)

    def save_cb(self, data):
        if not data: return
        sessions = []
        if os.path.exists(LOCAL_VAULT):
            with open(LOCAL_VAULT, "r") as f: 
                sessions = yaml.safe_load(f) or []
        updated = False
        for i, s in enumerate(sessions):
            if s.get('id') == data['id']: sessions[i], updated = data, True
        if not updated: sessions.append(data)
        with open(LOCAL_VAULT, "w") as f: yaml.dump(sessions, f)
        self.load_sessions()

if __name__ == "__main__":
    NeuroSSH().run()
